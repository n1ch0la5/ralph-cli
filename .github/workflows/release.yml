name: Release on Merge

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PAT }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine new version
        id: version
        run: |
          # Get current version from bin/ralph
          CURRENT_VERSION=$(grep -E '^RALPH_VERSION=' bin/ralph | cut -d'"' -f2)
          echo "Current version: $CURRENT_VERSION"

          # Check if this is a release branch (release/v0.2.0 or release/v1.0.0)
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "PR branch: $HEAD_BRANCH"

          if [[ "$HEAD_BRANCH" =~ ^release/v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            # Use version from branch name
            NEW_VERSION="${BASH_REMATCH[1]}"
            echo "Release branch detected, using version: $NEW_VERSION"
          else
            # Bump patch version
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
            echo "Regular branch, bumping patch: $NEW_VERSION"
          fi

          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Update version in bin/ralph
        run: |
          sed -i 's/^RALPH_VERSION=".*"/RALPH_VERSION="${{ steps.version.outputs.new_version }}"/' bin/ralph
          cat bin/ralph | head -5

      - name: Commit version bump
        run: |
          git add bin/ralph
          git commit -m "Bump version to ${{ steps.version.outputs.new_version }}"
          git push origin main

      - name: Create and push tag
        run: |
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      - name: Wait for tarball availability
        run: sleep 5

      - name: Compute tarball SHA256
        id: sha
        run: |
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/refs/tags/${{ steps.version.outputs.tag }}.tar.gz"
          echo "Fetching: $TARBALL_URL"

          # Retry a few times in case tarball isn't immediately available
          for i in {1..5}; do
            SHA256=$(curl -sL "$TARBALL_URL" | shasum -a 256 | cut -d' ' -f1)
            if [ -n "$SHA256" ] && [ "$SHA256" != "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855" ]; then
              # Not empty file hash
              break
            fi
            echo "Attempt $i: tarball not ready, waiting..."
            sleep 5
          done

          echo "SHA256: $SHA256"
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"

      - name: Update Homebrew tap
        env:
          TAP_PAT: ${{ secrets.HOMEBREW_TAP_PAT }}
        run: |
          # Clone the tap repository
          git clone https://x-access-token:${TAP_PAT}@github.com/n1ch0la5/homebrew-tap.git /tmp/homebrew-tap
          cd /tmp/homebrew-tap

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update the formula
          FORMULA="Formula/ralph-cli.rb"
          TAG="${{ steps.version.outputs.tag }}"
          SHA="${{ steps.sha.outputs.sha256 }}"

          sed -i "s|url \"https://github.com/n1ch0la5/ralph-cli/archive/refs/tags/v.*\.tar\.gz\"|url \"https://github.com/n1ch0la5/ralph-cli/archive/refs/tags/${TAG}.tar.gz\"|" "$FORMULA"
          sed -i "s|sha256 \".*\"|sha256 \"${SHA}\"|" "$FORMULA"

          echo "Updated formula:"
          head -10 "$FORMULA"

          # Commit and push
          git add "$FORMULA"
          git commit -m "Update ralph-cli to ${TAG}"
          git push origin main
